#!/bin/bash
EXE_NAME=gcc
function _agcc-msg { echo "[$EXE_NAME-lpthread]" "$@" >&2; }
function _agcc-dbg { [[ $AGCC_DBG ]] && _agcc-msg "$@"; }

###############################################################################
#Search exe in $PATH, but exclude myself.
#This is faster than using `which -a $EXE_NAME` then filter

EXE_PATH=""

#split $PATH by :, save it to pathList as array
IFS=: pathList=($PATH); unset IFS

foundMyself=""
for d in "${pathList[@]}"; do
    #if exe in the dir and not same as me, then that is the real path i want
    if [[ -f $d/$EXE_NAME ]]; then
        if [[ $d/$EXE_NAME -ef "$0" ]]; then
            foundMyself=YES
        else
            if [[ $foundMyself ]]; then
                EXE_PATH=$d/$EXE_NAME
                break
            fi
        fi
    fi
done

if [[ ! $EXE_PATH ]]; then
    _agcc-msg "$EXE_NAME not found."
    exit 1
fi

###############################################################################
#if already have -lpthread option then run command without change.

has_lLIB=""
for arg in "$@"; do
    if [[ $arg == -lpthread ]]; then
        _agcc-dbg "call \"$EXE_PATH\" (already specified -lpthread option)"
        exec "$EXE_PATH" "$@"
        exit
    elif [[ $arg == -l* ]]; then
        has_lLIB=1
    fi
done

#if not sure how to insert -lpthread option then run command without change.
if [[ ! $has_lLIB ]]; then
    _agcc-dbg "call \"$EXE_PATH\" (no any -lLIB option)"
    exec "$EXE_PATH" "$@"
    exit
fi

###############################################################################
#otherwise run command with -lpthread

_agcc-msg "call \"$EXE_PATH\" with -lpthread"
exec "$EXE_PATH" "$@" -lpthread
